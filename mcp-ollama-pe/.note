
 LangChain | Ollama + Function Calling

 Prompt Engineering Solution å®Œæ•´çš„æµç¨‹

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                    MCP Server                               â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                            â†“

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  æ„å»º messages                                               â”‚
  â”‚                                                              â”‚
  â”‚  role: "system"                                             â”‚
  â”‚  â”œâ”€ "ä½ æ˜¯äº§å“æŸ¥è¯¢åŠ©æ‰‹"                                      â”‚
  â”‚  â”œâ”€ "ä½ æœ‰è¿™äº›å·¥å…·ï¼š"                                        â”‚
  â”‚  â”‚  â”œâ”€ get_all_products                                    â”‚
  â”‚  â”‚  â”œâ”€ get_product                                         â”‚
  â”‚  â”‚  â”œâ”€ search_products_by_name                             â”‚
  â”‚  â”‚  â””â”€ ... (14 ä¸ªå·¥å…·)                                      â”‚
  â”‚  â””â”€ "å½“ä½ éœ€è¦å·¥å…·æ—¶ï¼Œç”¨ <tool_call>...</tool_call> æ ¼å¼"   â”‚
  â”‚                                                              â”‚
  â”‚  role: "user"                                               â”‚
  â”‚  â””â”€ "please list me all the product"                       â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                            â†“

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                    Ollama                                    â”‚
  â”‚                                                              â”‚
  â”‚  ğŸ¤– æˆ‘æ¥åˆ¤æ–­ï¼š                                              â”‚
  â”‚  1ï¸âƒ£ ç”¨æˆ·è¦ä»€ä¹ˆï¼Ÿâ†’ åˆ—å‡ºæ‰€æœ‰äº§å“                             â”‚
  â”‚  2ï¸âƒ£ æˆ‘æœ‰ä»€ä¹ˆå·¥å…·ï¼Ÿâ†’ çœ‹ system prompt                      â”‚
  â”‚  3ï¸âƒ£ å“ªä¸ªå·¥å…·é€‚åˆï¼Ÿâ†’ get_all_products!                      â”‚
  â”‚  4ï¸âƒ£ æ€ä¹ˆè°ƒç”¨ï¼Ÿâ†’ æŒ‰ç…§ system prompt çš„æ ¼å¼                â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                            â†“

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Ollama è¿”å›çš„å“åº”ï¼ˆinitial_responseï¼‰                      â”‚
  â”‚                                                              â”‚
  â”‚  <tool_call>                                                â”‚
  â”‚  {"name": "get_all_products", "arguments": {"limit": 100}} â”‚
  â”‚  </tool_call>                                               â”‚
  â”‚                                                              â”‚
  â”‚  I'll retrieve all products for you.                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                            â†“

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  _extract_tool_calls(initial_response)                      â”‚
  â”‚                                                              â”‚
  â”‚  ğŸ” ç”¨æ­£åˆ™è¡¨è¾¾å¼æå– <tool_call>...</tool_call> å—         â”‚
  â”‚                                                              â”‚
  â”‚  è¿”å›ï¼š                                                      â”‚
  â”‚  [                                                           â”‚
  â”‚    {                                                         â”‚
  â”‚      "name": "get_all_products",                            â”‚
  â”‚      "arguments": {"limit": 100}                            â”‚
  â”‚    }                                                         â”‚
  â”‚  ]                                                           â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                            â†“

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  tools.execute_tool("get_all_products", {"limit": 100})    â”‚
  â”‚                                                              â”‚
  â”‚  â†’ api_client.get_all_products(limit=100)                   â”‚
  â”‚  â†’ requests.get("http://localhost:8000/products")           â”‚
  â”‚  â†’ Flask API è¿”å›äº§å“åˆ—è¡¨                                   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    ğŸ“Š å®Œæ•´çš„è°ƒç”¨é“¾å¯è§†åŒ–

  Ollama è¿”å›
    â”‚
    â””â”€> initial_response = "<tool_call>...</tool_call>"
          â”‚
          â–¼
  _extract_tool_calls()
    â”‚
    â””â”€> tool_calls = [{"name": "get_all_products", "arguments": {"limit": 100}}]
          â”‚
          â–¼
  process_tool_call(tool_name, arguments)
    â”‚
    â””â”€> self.tools.execute_tool("get_all_products", {"limit": 100})
          â”‚
          â–¼
  tools.execute_tool()ï¼ˆmapping å±‚ï¼‰
    â”‚
    â”œâ”€ if tool_name == "get_all_products":
    â”‚    â”‚
    â”‚    â””â”€> self.api_client.get_all_products(limit=100)
    â”‚
    â””â”€> return json.dumps({"success": True, "data": [...]})
          â”‚
          â–¼
  api_client.get_all_products()
    â”‚
    â””â”€> self.get('/products')
          â”‚
          â””â”€> self._request('GET', '/products')
                â”‚
                â”œâ”€ url = "http://localhost:8000/products"
                â”‚
                â””â”€> requests.get(url)
                      â”‚
                      â–¼
                Flask API Server
                      â”‚
                      â””â”€> @products_bp.route('/', methods=['GET'])
                            â”‚
                            â”œâ”€ query_db('SELECT * FROM products')
                            â”‚
                            â””â”€> return jsonify(products)
                                  â”‚
                                  â–¼
                                è¿”å› JSON æ•°æ®

 ğŸ“ å®Œæ•´ä¾‹å­è¿½è¸ª

  è¾“å…¥ï¼š"please list me all the product"

  1. Ollama ç†è§£éœ€è¦ get_all_products
     â”‚
  2. è¿”å›ï¼š<tool_call>
             {"name": "get_all_products", "arguments": {"limit": 100}}
             </tool_call>
     â”‚
  3. _extract_tool_calls() æå–ï¼š
     tool_name = "get_all_products"
     arguments = {"limit": 100}
     â”‚
  4. tools.execute_tool("get_all_products", {"limit": 100})
     â”‚
     â”œâ”€ è¿›å…¥ if tool_name == "get_all_products":
     â”‚
     â”œâ”€ limit = 100
     â”‚
     â”œâ”€ result = api_client.get_all_products(limit=100)
     â”‚    â”‚
     â”‚    â””â”€ GET http://localhost:8000/products
     â”‚       â”‚
     â”‚       â””â”€ Flask API è¿”å›ï¼š[äº§å“åˆ—è¡¨]
     â”‚
     â””â”€ return json.dumps({"success": True, "data": [äº§å“åˆ—è¡¨]})
     â”‚
  5. å·¥å…·ç»“æœä¿å­˜åœ¨ tool_results ä¸­
     â”‚
  6. å†æ¬¡è°ƒç”¨ Ollamaï¼Œç”¨å·¥å…·ç»“æœç”Ÿæˆæœ€ç»ˆå›ç­”